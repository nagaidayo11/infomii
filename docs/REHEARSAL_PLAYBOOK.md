# Pre-Production Rehearsal Playbook

最終更新: 2026-02-20  
目的: 本番前に復旧導線・課金反映・権限制御を1回通しで検証する

## 1. 実施前準備（10分）
- 実施者を決める
  - 操作担当 1名
  - 確認担当 1名（同一人物でも可）
- 使用環境
  - ローカル: `http://localhost:3000`
  - Supabase: 対象プロジェクト
  - Stripe: test mode
- 監視を開く
  - `運用センター`
  - Supabase SQL Editor（必要時）
  - Stripe Dashboard / Stripe CLI（Webhook検証時）

## 2. 通しリハーサル手順（30〜45分）

### Phase A: Webhook不達想定 → 手動同期復旧
1. 通常のアップグレードを1回実行（test）
2. 反映が遅延/未反映の想定で `運用センター > Stripeを手動同期` を実行
3. ダッシュボードのプラン状態を確認
4. 監査ログに `billing.*` イベントが出ることを確認

合格条件:
- 同期後にプラン表示が期待どおりになる
- エラーが連続発生しない

### Phase B: 所属不整合（RLS）想定 → 再同期復旧
1. 操作中に所属不整合が起きた想定で `運用センター > 施設所属を再同期` を実行
2. `作成` で新規ページ作成、保存、公開を試す
3. RLS系エラーが解消されることを確認

合格条件:
- 新規作成・保存が成功する
- 監査ログに復旧操作が記録される

### Phase C: 誤削除想定 → 取り消し復元
1. 任意ページを削除
2. 5秒以内に `取り消し` をクリック
3. 一覧に復元されることを確認

合格条件:
- 復元に成功する
- タイトル/状態が削除前と一致する

### Phase D: 単一ロール確認（全ユーザー同一）
1. 別ユーザーでログイン
   - `運用センター` タブが表示される
   - `運用センター` API操作が実行できる
2. 直接 `?tab=ops` へアクセス
   - 運用センターが正常表示される

合格条件:
- どのユーザーでも同じ導線で復旧操作が実行できる

## 3. 失敗時の判断基準
- Blocker（本番リリース停止）
  - 課金反映が復旧できない
  - 運用センターの復旧操作が安定して使えない
  - 公開ページが安定表示できない
- Non-blocker（修正後に再テスト）
  - 文言不一致
  - 軽微なUI崩れ

## 4. 実施記録テンプレート

```md
# Rehearsal Record

- 実施日:
- 実施者:
- 対象環境: (local / staging / prod-like)
- コミットID:

## A. Webhook不達想定
- 結果: (PASS / FAIL)
- 事象:
- 対応:

## B. RLS復旧想定
- 結果: (PASS / FAIL)
- 事象:
- 対応:

## C. 誤削除復元
- 結果: (PASS / FAIL)
- 事象:
- 対応:

## D. 単一ロール確認
- 結果: (PASS / FAIL)
- 事象:
- 対応:

## 総評
- リリース可否: (GO / NO-GO)
- 残課題:
- 次アクション:
```

## 5. 実施後
- 記録を `docs/rehearsal-records/` 配下へ保存
- 記録テンプレート: `docs/rehearsal-records/TEMPLATE.md`
- 失敗が1つでもあれば、修正Issueを起票して再実施
